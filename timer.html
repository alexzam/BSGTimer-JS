<!DOCTYPE html>
<html>
<body>
<script type="text/javascript" src="jquery-1.5.2.min.js"></script>
<script type="text/javascript" src="jquery.svg.min.js"></script>
<script type="text/javascript" src="jquery-ui-1.8.15.custom.min.js"></script>
<script type="text/javascript" src="jquery.svgdom.min.js"></script>

<style>
	@import "css/jquery.ui.all.css";
	@import "jquery.svg.css";

	@font-face{
		font-family: Digital;
		src: url(DigifaceRegular.ttf);
	}
	.sector{
		/*stroke:white;
		strokeWidth:1;*/
	}
	#time{
		fill:#F5B800;
	}

	.inact{
		fill:none !important;
	}
	.s{
		fill:#A42F00;
	}
	.m{
		fill:#E68F00;
	}
	.h{
		fill:#F5B800;
	}
	.d{
		fill:#FBF400;
	}
	.mo{
		fill:#F7FF55;
	}
	body{
		background-color:black;
	}
	#clk{
		width:700px;
		height:700px;
	}
	#settings, #openbut{
		color:#F5B800;
		border:1px solid #F5B800;
	}
	#settings{
		width:200px;
		display:none;
	}
	#openbut{
		width:15px;
		height:15px;
		font-size:10px;
		line-height:15px;
		text-align:center;
		cursor:pointer;
	}
</style>
<script>
var targetDate = new Date(2011, 7, 8, 23, 38, 0, 0);

function azTimer(svg, func){
	this.timesvg = svg;
	this.fnCalc = func;
	var size = Math.min(svg._svg.width.baseVal.value, svg._svg.height.baseVal.value);
	var rad = Math.floor(size/2);
	var space = rad * 0.015;
	var wid = rad * 0.05;

	var g = svg.group({transform:"translate("+rad+","+rad+")"});
	rad *= 0.9;
	//svg.circle(g, 0, 0, rad, {fill: 'none', stroke: 'red', strokeWidth: 1});

	rad -= space;
	this.drawSegments(svg, g, 60, 0.85, rad - wid, rad, 's');
	rad -= wid + space;
	this.drawSegments(svg, g, 60, 0.85, rad - wid, rad, 'm');
	rad -= wid + space;
	this.drawSegments(svg, g, 24, 0.9, rad - wid, rad, 'h');
	rad -= wid + space;
	this.drawSegments(svg, g, 31, 0.85, rad - wid, rad, 'd');
	rad -= wid + space;
	this.drawSegments(svg, g, 12, 0.93, rad - wid, rad, 'mo');

	wid = rad * 0.25;
	svg.text(g, 0, Math.floor(wid/2), "Yooo 1234", {fontFamily:"Digital", fontSize:wid, textAnchor:'middle', id:'time'});
	$('#time', svg.root()).text('000 000000');
	this.notified = false;
}

azTimer.prototype.drawSegments = function(svg, parent,n,k,r1,r2,id){
	var i = 0;
	while(i<n){
		var a=2*Math.PI*i/n;
		var b=2*Math.PI*(i+k)/n;
		var path = svg.createPath();
		svg.path(parent,
			path.move((r2*Math.sin(a)), (-r2*Math.cos(a)))
				.arc(r2, r2, 0, 0, 1, (r2*Math.sin(b)), (-r2*Math.cos(b)))
				.line((r1*Math.sin(b)), (-r1*Math.cos(b)))
				.arc(r1, r1, 0, 0, 0, (r1*Math.sin(a)), (-r1*Math.cos(a)))
				.close()
			,
			{class:'sector '+id, id:id+i, val:i}
		);
		i++;
	}
}

azTimer.prototype.fillSectors = function(id, num){
	var circle = $('.sector', this.timesvg.root())
		.filter('.'+id);

	circle.filter(':gt('+num+')')
		.add(circle.filter(':eq('+num+')'))
		.addClass('inact');
//		.removeClass('act');
	circle.filter(':lt('+num+'),')
//		.addClass('act')
		.removeClass('inact');
}

azTimer.prototype.setRest = function(msec){
	var rest = Math.floor(msec / 1000);
	var cur = rest % 60;
	var text = ((cur<10)?'0':'') + cur;
	this.fillSectors('s', cur);

	rest = Math.floor(rest / 60);
	cur = rest % 60;
	text = ((cur<10)?'0':'') + cur + text;
	this.fillSectors('m', cur);

	rest = Math.floor(rest / 60);
	cur = rest % 24;
	text = ((cur<10)?' 0':' ') + cur + text;
	this.fillSectors('h', cur);

	rest = Math.floor(rest / 24);
	cur = rest % 31;
	text = ((cur<10)?'0':'') + cur + text;
	this.fillSectors('d', cur);

	rest = Math.floor(rest / 31);
	text = '' + (rest % 31) + text;
	this.fillSectors('mo', rest % 12);

	$('#time', this.timesvg.root()).text(text);
}

azTimer.prototype.updateTimer = function(){
	var rest = this.fnCalc();
	if(rest > 0){
		this.setRest(rest);
	} else if (!this.notified) {
		if (window.webkitNotifications) {
			window.webkitNotifications.createNotification(null, 'Timer is 0 now!', 'Webtimer came to its zero point.').show();
		}
		this.notified = true;
	}
}

var azTimerCollection = {
	timers:[],
	started:false,

	addTimer:function(t){
		azTimerCollection.timers.push(t);
	},
	updateTimers:function(){
		if(!azTimerCollection.started) return;
		for(i in azTimerCollection.timers){
			azTimerCollection.timers[i].updateTimer();
		}
		setTimeout(azTimerCollection.updateTimers, 1000);
	},
	start:function(){
		azTimerCollection.started = true;
		azTimerCollection.updateTimers();
	},
	stop:function(){
		azTimerCollection.started = false;
	},
	
	getFuncToTime:function(dt){
		return function(){
			return dt.getTime() - (new Date()).getTime();
		}
	},
	getFuncTotalTime:function(lng){
		var target = (new Date()).getTime() + lng;
		return function(){
			return target - (new Date()).getTime();
		}
	}
}

$(function(){
	$('#clk').svg(function(svg){
		//azTimerCollection.addTimer(new azTimer(svg, azTimerCollection.getFuncToTime(targetDate)));
		//azTimerCollection.addTimer(new azTimer(svg, azTimerCollection.getFuncTotalTime(60000)));
	});
	azTimerCollection.start();
	$('#openbut').toggle(function(){
		$(this).html('-');
		$('#settings').show('fast');
	},function(){
		$(this).html('+');
		$('#settings').hide('fast');
	});
	$('#tdate').datepicker({dateFormat:'dd.mm.yy'});
	$('#btStart').click(function(){
		if (window.webkitNotifications.checkPermission() != 0) {
			window.webkitNotifications.requestPermission();
		}

		azTimerCollection.stop();
		var dat = $('#tdate').datepicker('getDate');
		if(dat == null) return;
		dat.setHours($('#thour').val());
		dat.setMinutes($('#tmin').val());
		azTimerCollection.addTimer(new azTimer($('#clk').svg('get'), azTimerCollection.getFuncToTime(dat)));
		azTimerCollection.start();
		$('#openbut').click();
	});
});
</script>

<div id="clk"></div>

<div id="openbut">+</div>
<div id="settings">
	<input type="text" id="tdate" style="width:100px;"/>
	<br />
	<input type="text" id="thour" style="width:40px;"/>
	:
	<input type="text" id="tmin" style="width:40px;"/>
	<button id="btStart">Start</button>
</div>

</body>
</html>